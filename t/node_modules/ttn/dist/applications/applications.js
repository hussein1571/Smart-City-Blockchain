"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ApplicationClient = undefined;

var _keys = require("babel-runtime/core-js/object/keys");

var _keys2 = _interopRequireDefault(_keys);

var _extends2 = require("babel-runtime/helpers/extends");

var _extends3 = _interopRequireDefault(_extends2);

var _regenerator = require("babel-runtime/regenerator");

var _regenerator2 = _interopRequireDefault(_regenerator);

var _toConsumableArray2 = require("babel-runtime/helpers/toConsumableArray");

var _toConsumableArray3 = _interopRequireDefault(_toConsumableArray2);

var _asyncToGenerator2 = require("babel-runtime/helpers/asyncToGenerator");

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _classCallCheck2 = require("babel-runtime/helpers/classCallCheck");

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require("babel-runtime/helpers/createClass");

var _createClass3 = _interopRequireDefault(_createClass2);

var _sourceMapSupport2 = require("source-map-support");

var _grpc = require("grpc");

var _grpc2 = _interopRequireDefault(_grpc);

var _handler_pb = require("ttnapi/handler/handler_pb");

var _handler_pb2 = _interopRequireDefault(_handler_pb);

var _device_pb = require("ttnapi/protocol/lorawan/device_pb");

var _device_pb2 = _interopRequireDefault(_device_pb);

var _handler_grpc_pb = require("ttnapi/handler/handler_grpc_pb");

var _handler_grpc_pb2 = _interopRequireDefault(_handler_grpc_pb);

var _device_address_grpc_pb = require("ttnapi/protocol/lorawan/device_address_grpc_pb");

var _device_address_grpc_pb2 = _interopRequireDefault(_device_address_grpc_pb);

var _device_address_pb = require("ttnapi/protocol/lorawan/device_address_pb");

var _device_address_pb2 = _interopRequireDefault(_device_address_pb);

var _utils = require("../utils");

var _isToken = require("../utils/is-token");

var _isToken2 = _interopRequireDefault(_isToken);

var _account = require("../account");

var _normalize = require("./normalize");

var _normalize2 = _interopRequireDefault(_normalize);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

(0, _sourceMapSupport2.install)(); // Copyright Â© 2017 The Things Network
// Use of this source code is governed by the MIT license that can be found in the LICENSE file.

// Necessary to make gRPC work
process.env.GRPC_SSL_CIPHER_SUITES = _utils.MODERN_CIPHER_SUITES;

/**
 * A client that manages devices on the handler.
 */

var ApplicationClient = exports.ApplicationClient = function () {

  /**
   * Create and open an application manager client that can be used for
   * retreiving and updating an application and its devices.
   *
   * @param appID - The ID of the application you want to manage
   * @param tokenOrKey - The Access Token or Access Key used to authenticate
   * @param netAddress - The gRPC address of the handler where the application is registered
   * @param certificate - An optional certificate used to connect to the handler securely
   */


  /** @private */


  /** @private */


  /** @private */
  function ApplicationClient(appID, tokenOrKey, netAddress, certificate) {
    (0, _classCallCheck3.default)(this, ApplicationClient);

    var credentials = certificate ? _grpc2.default.credentials.createSsl(certificate && new Buffer(certificate)) : _grpc2.default.credentials.createInsecure();

    this.client = new _handler_grpc_pb2.default.ApplicationManagerClient(netAddress, credentials);
    this.credentials = credentials;
    this.netAddress = netAddress;
    this.appID = appID;

    if ((0, _isToken2.default)(tokenOrKey)) {
      this.appAccessToken = tokenOrKey;
    } else {
      this.appAccessKey = tokenOrKey;
    }

    this.accountClient = new _account.AccountClient(tokenOrKey);
  }

  /** @private */


  /** @private */


  /** @private */


  /** @private */


  /** @private */


  (0, _createClass3.default)(ApplicationClient, [{
    key: "exec",
    value: function () {
      var _ref = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee(fn) {
        for (var _len = arguments.length, args = Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
          args[_key - 1] = arguments[_key];
        }

        var meta, res;
        return _regenerator2.default.wrap(function _callee$(_context) {
          while (1) {
            switch (_context.prev = _context.next) {
              case 0:
                meta = new _grpc2.default.Metadata();

                if (this.appAccessToken) {
                  meta.add("token", this.appAccessToken);
                } else if (this.appAccessKey) {
                  meta.add("key", this.appAccessKey);
                }

                _context.next = 4;
                return _utils.wrap.apply(undefined, [this.client, fn].concat((0, _toConsumableArray3.default)(args), [meta]));

              case 4:
                res = _context.sent;
                return _context.abrupt("return", res.toObject());

              case 6:
              case "end":
                return _context.stop();
            }
          }
        }, _callee, this);
      }));

      function exec(_x) {
        return _ref.apply(this, arguments);
      }

      return exec;
    }()

    /**
     * Get the application
     */

  }, {
    key: "get",
    value: function () {
      var _ref2 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee2() {
        var req, app;
        return _regenerator2.default.wrap(function _callee2$(_context2) {
          while (1) {
            switch (_context2.prev = _context2.next) {
              case 0:
                req = new _handler_pb2.default.ApplicationIdentifier();

                req.setAppId(this.appID);

                _context2.next = 4;
                return this.exec(this.client.getApplication, req);

              case 4:
                app = _context2.sent;

                app.payloadFormat = app.payloadFormat || "custom";

                return _context2.abrupt("return", app);

              case 7:
              case "end":
                return _context2.stop();
            }
          }
        }, _callee2, this);
      }));

      function get() {
        return _ref2.apply(this, arguments);
      }

      return get;
    }()

    /**
     * Change the payload format of the application.
     */

  }, {
    key: "setPayloadFormat",
    value: function () {
      var _ref3 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee3(format) {
        return _regenerator2.default.wrap(function _callee3$(_context3) {
          while (1) {
            switch (_context3.prev = _context3.next) {
              case 0:
                _context3.next = 2;
                return this.set({
                  payloadFormat: format
                });

              case 2:
              case "end":
                return _context3.stop();
            }
          }
        }, _callee3, this);
      }));

      function setPayloadFormat(_x2) {
        return _ref3.apply(this, arguments);
      }

      return setPayloadFormat;
    }()

    /**
     * Set the custom payload functions of the application and set the format
     * to custom.
     */

  }, {
    key: "setCustomPayloadFunctions",
    value: function () {
      var _ref4 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee4() {
        var fns = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};
        return _regenerator2.default.wrap(function _callee4$(_context4) {
          while (1) {
            switch (_context4.prev = _context4.next) {
              case 0:
                _context4.next = 2;
                return this.set((0, _extends3.default)({
                  payloadFormat: "custom"
                }, fns));

              case 2:
              case "end":
                return _context4.stop();
            }
          }
        }, _callee4, this);
      }));

      function setCustomPayloadFunctions() {
        return _ref4.apply(this, arguments);
      }

      return setCustomPayloadFunctions;
    }()

    /**
     * Set the registerOnJoinAccessKey or remove it.
     */

  }, {
    key: "setRegisterOnJoinAccessKey",
    value: function () {
      var _ref5 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee5(to) {
        return _regenerator2.default.wrap(function _callee5$(_context5) {
          while (1) {
            switch (_context5.prev = _context5.next) {
              case 0:
                _context5.next = 2;
                return this.set({
                  registerOnJoinAccessKey: to
                });

              case 2:
              case "end":
                return _context5.stop();
            }
          }
        }, _callee5, this);
      }));

      function setRegisterOnJoinAccessKey(_x4) {
        return _ref5.apply(this, arguments);
      }

      return setRegisterOnJoinAccessKey;
    }()

    /**
     * Unregister the application from the handler.
     */

  }, {
    key: "unregister",
    value: function () {
      var _ref6 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee6() {
        var req;
        return _regenerator2.default.wrap(function _callee6$(_context6) {
          while (1) {
            switch (_context6.prev = _context6.next) {
              case 0:
                req = new _handler_pb2.default.ApplicationIdentifier();

                req.setAppId(this.appID);
                return _context6.abrupt("return", this.exec(this.client.deleteApplication, req));

              case 3:
              case "end":
                return _context6.stop();
            }
          }
        }, _callee6, this);
      }));

      function unregister() {
        return _ref6.apply(this, arguments);
      }

      return unregister;
    }()

    /** @private */

  }, {
    key: "set",
    value: function () {
      var _ref7 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee7() {
        var updates = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};
        var req;
        return _regenerator2.default.wrap(function _callee7$(_context7) {
          while (1) {
            switch (_context7.prev = _context7.next) {
              case 0:
                req = new _handler_pb2.default.Application();


                req.setAppId(this.appID);

                if ("payloadFormat" in updates) {
                  req.setPayloadFormat(updates.payloadFormat);
                }

                if ("registerOnJoinAccessKey" in updates) {
                  req.setRegisterOnJoinAccessKey(updates.registerOnJoinAccessKey);
                }

                if ("decoder" in updates) {
                  req.setDecoder(updates.decoder);
                }

                if ("converter" in updates) {
                  req.setConverter(updates.converter);
                }

                if ("validator" in updates) {
                  req.setValidator(updates.validator);
                }

                if ("encoder" in updates) {
                  req.setEncoder(updates.encoder);
                }

                return _context7.abrupt("return", this.exec(this.client.setApplication, req));

              case 9:
              case "end":
                return _context7.stop();
            }
          }
        }, _callee7, this);
      }));

      function set() {
        return _ref7.apply(this, arguments);
      }

      return set;
    }()

    /**
     * List the devices of the application
     */

  }, {
    key: "devices",
    value: function () {
      var _ref8 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee8() {
        var req, res;
        return _regenerator2.default.wrap(function _callee8$(_context8) {
          while (1) {
            switch (_context8.prev = _context8.next) {
              case 0:
                req = new _handler_pb2.default.ApplicationIdentifier();

                req.setAppId(this.appID);
                _context8.next = 4;
                return this.exec(this.client.getDevicesForApplication, req);

              case 4:
                res = _context8.sent;
                return _context8.abrupt("return", res.devicesList.map(_normalize2.default));

              case 6:
              case "end":
                return _context8.stop();
            }
          }
        }, _callee8, this);
      }));

      function devices() {
        return _ref8.apply(this, arguments);
      }

      return devices;
    }()

    /**
     * Register a device in the application.
     */

  }, {
    key: "registerDevice",
    value: function () {
      var _ref9 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee9(devID, device) {
        return _regenerator2.default.wrap(function _callee9$(_context9) {
          while (1) {
            switch (_context9.prev = _context9.next) {
              case 0:
                return _context9.abrupt("return", this.setDevice(devID, device));

              case 1:
              case "end":
                return _context9.stop();
            }
          }
        }, _callee9, this);
      }));

      function registerDevice(_x6, _x7) {
        return _ref9.apply(this, arguments);
      }

      return registerDevice;
    }()

    /**
     * Get the device specified by the devID
     */

  }, {
    key: "device",
    value: function () {
      var _ref10 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee10(devID) {
        var req, res;
        return _regenerator2.default.wrap(function _callee10$(_context10) {
          while (1) {
            switch (_context10.prev = _context10.next) {
              case 0:
                req = new _handler_pb2.default.DeviceIdentifier();

                req.setAppId(this.appID);
                req.setDevId(devID);
                _context10.next = 5;
                return this.exec(this.client.getDevice, req);

              case 5:
                res = _context10.sent;
                return _context10.abrupt("return", (0, _normalize2.default)(res));

              case 7:
              case "end":
                return _context10.stop();
            }
          }
        }, _callee10, this);
      }));

      function device(_x8) {
        return _ref10.apply(this, arguments);
      }

      return device;
    }()

    /** @private */

  }, {
    key: "setDevice",
    value: function () {
      var _ref11 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee11(devID, device) {
        var req;
        return _regenerator2.default.wrap(function _callee11$(_context11) {
          while (1) {
            switch (_context11.prev = _context11.next) {
              case 0:
                req = this.deviceRequest(devID, device);
                return _context11.abrupt("return", this.exec(this.client.setDevice, req));

              case 2:
              case "end":
                return _context11.stop();
            }
          }
        }, _callee11, this);
      }));

      function setDevice(_x9, _x10) {
        return _ref11.apply(this, arguments);
      }

      return setDevice;
    }()

    /**
     * Update the device specified by the devID with the specified updates
     */

  }, {
    key: "updateDevice",
    value: function () {
      var _ref12 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee12(devID, updates) {
        var device, req;
        return _regenerator2.default.wrap(function _callee12$(_context12) {
          while (1) {
            switch (_context12.prev = _context12.next) {
              case 0:
                _context12.next = 2;
                return this.device(devID);

              case 2:
                device = _context12.sent;
                req = this.deviceRequest(devID, (0, _extends3.default)({}, device, updates));
                return _context12.abrupt("return", this.exec(this.client.setDevice, req));

              case 5:
              case "end":
                return _context12.stop();
            }
          }
        }, _callee12, this);
      }));

      function updateDevice(_x11, _x12) {
        return _ref12.apply(this, arguments);
      }

      return updateDevice;
    }()

    /**
     * Delete the specified device.
     */

  }, {
    key: "deleteDevice",
    value: function () {
      var _ref13 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee13(devID) {
        var req;
        return _regenerator2.default.wrap(function _callee13$(_context13) {
          while (1) {
            switch (_context13.prev = _context13.next) {
              case 0:
                req = new _handler_pb2.default.DeviceIdentifier();

                req.setAppId(this.appID);
                req.setDevId(devID);
                return _context13.abrupt("return", this.exec(this.client.deleteDevice, req));

              case 4:
              case "end":
                return _context13.stop();
            }
          }
        }, _callee13, this);
      }));

      function deleteDevice(_x13) {
        return _ref13.apply(this, arguments);
      }

      return deleteDevice;
    }()

    /** @private */

  }, {
    key: "deviceRequest",
    value: function deviceRequest(devID) {
      var device = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};

      var req = new _handler_pb2.default.Device();
      req.setAppId(this.appID);
      req.setDevId(devID);

      if ("description" in device) {
        req.setDescription(device.description);
      }

      if ("latitude" in device) {
        req.setLatitude(device.latitude);
      }

      if ("longitude" in device) {
        req.setLongitude(device.longitude);
      }

      if ("altitude" in device) {
        req.setAltitude(device.altitude);
      }

      if ("attributes" in device) {
        (0, _keys2.default)(device.attributes).forEach(function (key) {
          req.getAttributesMap().set(key, device.attributes[key]);
        });
      }

      req.setLorawanDevice(this.lorawanDeviceRequest(devID, device));

      return req;
    }

    /** @private */

  }, {
    key: "lorawanDeviceRequest",
    value: function lorawanDeviceRequest(devID) {
      var device = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};

      var req = new _device_pb2.default.Device();

      req.setAppId(this.appID);
      req.setDevId(devID);

      if ("appEui" in device) {
        req.setAppEui(new Uint8Array(new Buffer(device.appEui, "hex")));
      }

      if ("devEui" in device) {
        req.setDevEui(new Uint8Array(new Buffer(device.devEui, "hex")));
      }

      if ("devAddr" in device) {
        req.setDevAddr(new Uint8Array(new Buffer(device.devAddr, "hex")));
      }

      if ("nwkSKey" in device) {
        req.setNwkSKey(new Uint8Array(new Buffer(device.nwkSKey, "hex")));
      }

      if ("appSKey" in device) {
        req.setAppSKey(new Uint8Array(new Buffer(device.appSKey, "hex")));
      }

      if ("appKey" in device) {
        req.setAppKey(new Uint8Array(new Buffer(device.appKey, "hex")));
      }

      if ("fCntUp" in device) {
        req.setFCntUp(device.fCntUp);
      }

      if ("fCntDown" in device) {
        req.setFCntDown(device.fCntDown);
      }

      if ("disableFCntCheck" in device) {
        req.setDisableFCntCheck(device.disableFCntCheck);
      }

      if ("uses32BitFCnt" in device) {
        req.setUses32BitFCnt(device.uses32BitFCnt);
      }

      return req;
    }

    /**
     * Returns the EUI(s) for this application from the account server.
     */

  }, {
    key: "getEUIs",
    value: function () {
      var _ref14 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee14() {
        var appInfo;
        return _regenerator2.default.wrap(function _callee14$(_context14) {
          while (1) {
            switch (_context14.prev = _context14.next) {
              case 0:
                _context14.next = 2;
                return this.accountClient.getApplication(this.appID);

              case 2:
                appInfo = _context14.sent;
                return _context14.abrupt("return", appInfo.euis);

              case 4:
              case "end":
                return _context14.stop();
            }
          }
        }, _callee14, this);
      }));

      function getEUIs() {
        return _ref14.apply(this, arguments);
      }

      return getEUIs;
    }()

    /**
     * Return a device address for the given constraints.
     *
     * @param usage - The list for wich the address will be used.
     * @returns address - A buffer containing the address.
     */

  }, {
    key: "getDeviceAddress",
    value: function () {
      var _ref15 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee15() {
        var usage = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : ["abp"];
        var client, req, res;
        return _regenerator2.default.wrap(function _callee15$(_context15) {
          while (1) {
            switch (_context15.prev = _context15.next) {
              case 0:
                client = new _device_address_grpc_pb2.default.DevAddrManagerClient(this.netAddress, this.credentials);
                req = new _device_address_pb2.default.DevAddrRequest();

                req.setUsageList(usage);

                _context15.next = 5;
                return this.exec(client.getDevAddr, req);

              case 5:
                res = _context15.sent;
                return _context15.abrupt("return", new Buffer(res.devAddr, "base64"));

              case 7:
              case "end":
                return _context15.stop();
            }
          }
        }, _callee15, this);
      }));

      function getDeviceAddress() {
        return _ref15.apply(this, arguments);
      }

      return getDeviceAddress;
    }()
  }]);
  return ApplicationClient;
}();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hcHBsaWNhdGlvbnMvYXBwbGljYXRpb25zLmpzIl0sIm5hbWVzIjpbInByb2Nlc3MiLCJlbnYiLCJHUlBDX1NTTF9DSVBIRVJfU1VJVEVTIiwiTU9ERVJOX0NJUEhFUl9TVUlURVMiLCJBcHBsaWNhdGlvbkNsaWVudCIsImFwcElEIiwidG9rZW5PcktleSIsIm5ldEFkZHJlc3MiLCJjZXJ0aWZpY2F0ZSIsImNyZWRlbnRpYWxzIiwiZ3JwYyIsImNyZWF0ZVNzbCIsIkJ1ZmZlciIsImNyZWF0ZUluc2VjdXJlIiwiY2xpZW50IiwiaGFuZGxlciIsIkFwcGxpY2F0aW9uTWFuYWdlckNsaWVudCIsImFwcEFjY2Vzc1Rva2VuIiwiYXBwQWNjZXNzS2V5IiwiYWNjb3VudENsaWVudCIsIkFjY291bnRDbGllbnQiLCJmbiIsImFyZ3MiLCJtZXRhIiwiTWV0YWRhdGEiLCJhZGQiLCJ3cmFwIiwicmVzIiwidG9PYmplY3QiLCJyZXEiLCJwcm90byIsIkFwcGxpY2F0aW9uSWRlbnRpZmllciIsInNldEFwcElkIiwiZXhlYyIsImdldEFwcGxpY2F0aW9uIiwiYXBwIiwicGF5bG9hZEZvcm1hdCIsImZvcm1hdCIsInNldCIsImZucyIsInRvIiwicmVnaXN0ZXJPbkpvaW5BY2Nlc3NLZXkiLCJkZWxldGVBcHBsaWNhdGlvbiIsInVwZGF0ZXMiLCJBcHBsaWNhdGlvbiIsInNldFBheWxvYWRGb3JtYXQiLCJzZXRSZWdpc3Rlck9uSm9pbkFjY2Vzc0tleSIsInNldERlY29kZXIiLCJkZWNvZGVyIiwic2V0Q29udmVydGVyIiwiY29udmVydGVyIiwic2V0VmFsaWRhdG9yIiwidmFsaWRhdG9yIiwic2V0RW5jb2RlciIsImVuY29kZXIiLCJzZXRBcHBsaWNhdGlvbiIsImdldERldmljZXNGb3JBcHBsaWNhdGlvbiIsImRldmljZXNMaXN0IiwibWFwIiwibm9ybWFsaXplIiwiZGV2SUQiLCJkZXZpY2UiLCJzZXREZXZpY2UiLCJEZXZpY2VJZGVudGlmaWVyIiwic2V0RGV2SWQiLCJnZXREZXZpY2UiLCJkZXZpY2VSZXF1ZXN0IiwiZGVsZXRlRGV2aWNlIiwiRGV2aWNlIiwic2V0RGVzY3JpcHRpb24iLCJkZXNjcmlwdGlvbiIsInNldExhdGl0dWRlIiwibGF0aXR1ZGUiLCJzZXRMb25naXR1ZGUiLCJsb25naXR1ZGUiLCJzZXRBbHRpdHVkZSIsImFsdGl0dWRlIiwiYXR0cmlidXRlcyIsImZvckVhY2giLCJrZXkiLCJnZXRBdHRyaWJ1dGVzTWFwIiwic2V0TG9yYXdhbkRldmljZSIsImxvcmF3YW5EZXZpY2VSZXF1ZXN0IiwibG9yYXdhbiIsInNldEFwcEV1aSIsIlVpbnQ4QXJyYXkiLCJhcHBFdWkiLCJzZXREZXZFdWkiLCJkZXZFdWkiLCJzZXREZXZBZGRyIiwiZGV2QWRkciIsInNldE53a1NLZXkiLCJud2tTS2V5Iiwic2V0QXBwU0tleSIsImFwcFNLZXkiLCJzZXRBcHBLZXkiLCJhcHBLZXkiLCJzZXRGQ250VXAiLCJmQ250VXAiLCJzZXRGQ250RG93biIsImZDbnREb3duIiwic2V0RGlzYWJsZUZDbnRDaGVjayIsImRpc2FibGVGQ250Q2hlY2siLCJzZXRVc2VzMzJCaXRGQ250IiwidXNlczMyQml0RkNudCIsImFwcEluZm8iLCJldWlzIiwidXNhZ2UiLCJhZGRyIiwiRGV2QWRkck1hbmFnZXJDbGllbnQiLCJkZXZhZGRyIiwiRGV2QWRkclJlcXVlc3QiLCJzZXRVc2FnZUxpc3QiLCJnZXREZXZBZGRyIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBS0E7Ozs7QUFFQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBRUE7O0FBQ0E7Ozs7QUFDQTs7QUFFQTs7Ozs7O21DQWpCQTtBQUNBOztBQXNCQTtBQUNBQSxRQUFRQyxHQUFSLENBQVlDLHNCQUFaLEdBQXFDQywyQkFBckM7O0FBRUE7Ozs7SUFHYUMsaUIsV0FBQUEsaUI7O0FBdUJYOzs7Ozs7Ozs7OztBQU5BOzs7QUFOQTs7O0FBTkE7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SixDQUFxQjFDLE9BQU8yQyxhQUE1QjtBQUNEOztBQUVELGFBQU8zRSxHQUFQO0FBQ0Q7O0FBRUQ7Ozs7Ozs7Ozs7Ozs7O3VCQUl3QixLQUFLVixhQUFMLENBQW1CZSxjQUFuQixDQUFrQyxLQUFLN0IsS0FBdkMsQzs7O0FBQWhCb0csdUI7bURBRUNBLFFBQVFDLEk7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBR2pCOzs7Ozs7Ozs7OztZQU13QkMsSyx1RUFBdUIsQ0FBRSxLQUFGLEM7Ozs7OztBQUN2QzdGLHNCLEdBQVMsSUFBSThGLGlDQUFLQyxvQkFBVCxDQUE4QixLQUFLdEcsVUFBbkMsRUFBK0MsS0FBS0UsV0FBcEQsQztBQUNUb0IsbUIsR0FBTSxJQUFJaUYsNEJBQVFDLGNBQVosRTs7QUFDWmxGLG9CQUFJbUYsWUFBSixDQUFpQkwsS0FBakI7Ozt1QkFFa0IsS0FBSzFFLElBQUwsQ0FBVW5CLE9BQU9tRyxVQUFqQixFQUE2QnBGLEdBQTdCLEM7OztBQUFaRixtQjttREFFQyxJQUFJZixNQUFKLENBQVdlLElBQUkrRCxPQUFmLEVBQXdCLFFBQXhCLEMiLCJmaWxlIjoiYXBwbGljYXRpb25zLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IMKpIDIwMTcgVGhlIFRoaW5ncyBOZXR3b3JrXG4vLyBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSB0aGUgTUlUIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS5cblxuLy8gQGZsb3dcblxuaW1wb3J0IGdycGMgZnJvbSBcImdycGNcIlxuXG5pbXBvcnQgcHJvdG8gZnJvbSBcInR0bmFwaS9oYW5kbGVyL2hhbmRsZXJfcGJcIlxuaW1wb3J0IGxvcmF3YW4gZnJvbSBcInR0bmFwaS9wcm90b2NvbC9sb3Jhd2FuL2RldmljZV9wYlwiXG5pbXBvcnQgaGFuZGxlciBmcm9tIFwidHRuYXBpL2hhbmRsZXIvaGFuZGxlcl9ncnBjX3BiXCJcbmltcG9ydCBhZGRyIGZyb20gXCJ0dG5hcGkvcHJvdG9jb2wvbG9yYXdhbi9kZXZpY2VfYWRkcmVzc19ncnBjX3BiXCJcbmltcG9ydCBkZXZhZGRyIGZyb20gXCJ0dG5hcGkvcHJvdG9jb2wvbG9yYXdhbi9kZXZpY2VfYWRkcmVzc19wYlwiXG5cbmltcG9ydCB7IHdyYXAsIE1PREVSTl9DSVBIRVJfU1VJVEVTIH0gZnJvbSBcIi4uL3V0aWxzXCJcbmltcG9ydCBpc1Rva2VuIGZyb20gXCIuLi91dGlscy9pcy10b2tlblwiXG5pbXBvcnQgeyBBY2NvdW50Q2xpZW50IH0gZnJvbSBcIi4uL2FjY291bnRcIlxuXG5pbXBvcnQgbm9ybWFsaXplIGZyb20gXCIuL25vcm1hbGl6ZVwiXG5cbmltcG9ydCB0eXBlIHsgRGV2aWNlLCBBcHBsaWNhdGlvbiwgQXBwbGljYXRpb25VcGRhdGVzLCBQYXlsb2FkRnVuY3Rpb25zLCBEZXZpY2VVcGRhdGVzLCBMb3Jhd2FuRGV2aWNlVXBkYXRlcywgUGF5bG9hZEZvcm1hdCB9IGZyb20gXCIuL3R5cGVzXCJcblxudHlwZSBVc2FnZSA9IFwib3RhYVwiIHwgXCJhYnBcIiB8IFwid29ybGRcIiB8IFwibG9jYWxcIiB8IFwicHJpdmF0ZVwiIHwgXCJ0ZXN0aW5nXCJcblxuLy8gTmVjZXNzYXJ5IHRvIG1ha2UgZ1JQQyB3b3JrXG5wcm9jZXNzLmVudi5HUlBDX1NTTF9DSVBIRVJfU1VJVEVTID0gTU9ERVJOX0NJUEhFUl9TVUlURVNcblxuLyoqXG4gKiBBIGNsaWVudCB0aGF0IG1hbmFnZXMgZGV2aWNlcyBvbiB0aGUgaGFuZGxlci5cbiAqL1xuZXhwb3J0IGNsYXNzIEFwcGxpY2F0aW9uQ2xpZW50IHtcblxuICAvKiogQHByaXZhdGUgKi9cbiAgYXBwSUQgOiBzdHJpbmdcblxuICAvKiogQHByaXZhdGUgKi9cbiAgYXBwQWNjZXNzS2V5IDogP3N0cmluZ1xuXG4gIC8qKiBAcHJpdmF0ZSAqL1xuICBhcHBBY2Nlc3NUb2tlbiA6ID9zdHJpbmdcblxuICAvKiogQHByaXZhdGUgKi9cbiAgY2xpZW50IDogYW55XG5cbiAgLyoqIEBwcml2YXRlICovXG4gIGFjY291bnRDbGllbnQgOiBBY2NvdW50Q2xpZW50XG5cbiAgLyoqIEBwcml2YXRlICovXG4gIGNyZWRlbnRpYWxzIDogYW55XG5cbiAgLyoqIEBwcml2YXRlICovXG4gIG5ldEFkZHJlc3MgOiBzdHJpbmdcblxuICAvKipcbiAgICogQ3JlYXRlIGFuZCBvcGVuIGFuIGFwcGxpY2F0aW9uIG1hbmFnZXIgY2xpZW50IHRoYXQgY2FuIGJlIHVzZWQgZm9yXG4gICAqIHJldHJlaXZpbmcgYW5kIHVwZGF0aW5nIGFuIGFwcGxpY2F0aW9uIGFuZCBpdHMgZGV2aWNlcy5cbiAgICpcbiAgICogQHBhcmFtIGFwcElEIC0gVGhlIElEIG9mIHRoZSBhcHBsaWNhdGlvbiB5b3Ugd2FudCB0byBtYW5hZ2VcbiAgICogQHBhcmFtIHRva2VuT3JLZXkgLSBUaGUgQWNjZXNzIFRva2VuIG9yIEFjY2VzcyBLZXkgdXNlZCB0byBhdXRoZW50aWNhdGVcbiAgICogQHBhcmFtIG5ldEFkZHJlc3MgLSBUaGUgZ1JQQyBhZGRyZXNzIG9mIHRoZSBoYW5kbGVyIHdoZXJlIHRoZSBhcHBsaWNhdGlvbiBpcyByZWdpc3RlcmVkXG4gICAqIEBwYXJhbSBjZXJ0aWZpY2F0ZSAtIEFuIG9wdGlvbmFsIGNlcnRpZmljYXRlIHVzZWQgdG8gY29ubmVjdCB0byB0aGUgaGFuZGxlciBzZWN1cmVseVxuICAgKi9cbiAgY29uc3RydWN0b3IgKGFwcElEIDogc3RyaW5nLCB0b2tlbk9yS2V5IDogc3RyaW5nLCBuZXRBZGRyZXNzIDogc3RyaW5nLCBjZXJ0aWZpY2F0ZSA6ID8oQnVmZmVyIHwgc3RyaW5nKSkgOiB2b2lkIHtcbiAgICBjb25zdCBjcmVkZW50aWFscyA9XG4gICAgICBjZXJ0aWZpY2F0ZVxuICAgICAgICA/IGdycGMuY3JlZGVudGlhbHMuY3JlYXRlU3NsKGNlcnRpZmljYXRlICYmIG5ldyBCdWZmZXIoY2VydGlmaWNhdGUpKVxuICAgICAgICA6IGdycGMuY3JlZGVudGlhbHMuY3JlYXRlSW5zZWN1cmUoKVxuXG4gICAgdGhpcy5jbGllbnQgPSBuZXcgaGFuZGxlci5BcHBsaWNhdGlvbk1hbmFnZXJDbGllbnQobmV0QWRkcmVzcywgY3JlZGVudGlhbHMpXG4gICAgdGhpcy5jcmVkZW50aWFscyA9IGNyZWRlbnRpYWxzXG4gICAgdGhpcy5uZXRBZGRyZXNzID0gbmV0QWRkcmVzc1xuICAgIHRoaXMuYXBwSUQgPSBhcHBJRFxuXG4gICAgaWYgKGlzVG9rZW4odG9rZW5PcktleSkpIHtcbiAgICAgIHRoaXMuYXBwQWNjZXNzVG9rZW4gPSB0b2tlbk9yS2V5XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuYXBwQWNjZXNzS2V5ID0gdG9rZW5PcktleVxuICAgIH1cblxuICAgIHRoaXMuYWNjb3VudENsaWVudCA9IG5ldyBBY2NvdW50Q2xpZW50KHRva2VuT3JLZXkpXG4gIH1cblxuICAvKiogQHByaXZhdGUgKi9cbiAgYXN5bmMgZXhlYyAoZm4gOiBGdW5jdGlvbiwgLi4uYXJncyA6IGFueVtdKSA6IFByb21pc2U8Kj4ge1xuICAgIGNvbnN0IG1ldGEgPSBuZXcgZ3JwYy5NZXRhZGF0YSgpXG4gICAgaWYgKHRoaXMuYXBwQWNjZXNzVG9rZW4pIHtcbiAgICAgIG1ldGEuYWRkKFwidG9rZW5cIiwgdGhpcy5hcHBBY2Nlc3NUb2tlbilcbiAgICB9IGVsc2UgaWYgKHRoaXMuYXBwQWNjZXNzS2V5KSB7XG4gICAgICBtZXRhLmFkZChcImtleVwiLCB0aGlzLmFwcEFjY2Vzc0tleSlcbiAgICB9XG5cbiAgICBjb25zdCByZXMgPSBhd2FpdCB3cmFwKHRoaXMuY2xpZW50LCBmbiwgLi4uYXJncywgbWV0YSlcblxuICAgIHJldHVybiByZXMudG9PYmplY3QoKVxuICB9XG5cbiAgLyoqXG4gICAqIEdldCB0aGUgYXBwbGljYXRpb25cbiAgICovXG4gIGFzeW5jIGdldCAoKSA6IFByb21pc2U8QXBwbGljYXRpb24+IHtcbiAgICBjb25zdCByZXEgPSBuZXcgcHJvdG8uQXBwbGljYXRpb25JZGVudGlmaWVyKClcbiAgICByZXEuc2V0QXBwSWQodGhpcy5hcHBJRClcblxuICAgIGNvbnN0IGFwcCA9IGF3YWl0IHRoaXMuZXhlYyh0aGlzLmNsaWVudC5nZXRBcHBsaWNhdGlvbiwgcmVxKVxuICAgIGFwcC5wYXlsb2FkRm9ybWF0ID0gYXBwLnBheWxvYWRGb3JtYXQgfHwgXCJjdXN0b21cIlxuXG4gICAgcmV0dXJuIGFwcFxuICB9XG5cbiAgLyoqXG4gICAqIENoYW5nZSB0aGUgcGF5bG9hZCBmb3JtYXQgb2YgdGhlIGFwcGxpY2F0aW9uLlxuICAgKi9cbiAgYXN5bmMgc2V0UGF5bG9hZEZvcm1hdCAoZm9ybWF0IDogUGF5bG9hZEZvcm1hdCkgOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBhd2FpdCB0aGlzLnNldCh7XG4gICAgICBwYXlsb2FkRm9ybWF0OiBmb3JtYXQsXG4gICAgfSlcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgdGhlIGN1c3RvbSBwYXlsb2FkIGZ1bmN0aW9ucyBvZiB0aGUgYXBwbGljYXRpb24gYW5kIHNldCB0aGUgZm9ybWF0XG4gICAqIHRvIGN1c3RvbS5cbiAgICovXG4gIGFzeW5jIHNldEN1c3RvbVBheWxvYWRGdW5jdGlvbnMgKGZucyA6IFBheWxvYWRGdW5jdGlvbnMgPSB7fSkgOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBhd2FpdCB0aGlzLnNldCh7XG4gICAgICBwYXlsb2FkRm9ybWF0OiBcImN1c3RvbVwiLFxuICAgICAgLi4uZm5zLFxuICAgIH0pXG4gIH1cblxuICAvKipcbiAgICogU2V0IHRoZSByZWdpc3Rlck9uSm9pbkFjY2Vzc0tleSBvciByZW1vdmUgaXQuXG4gICAqL1xuICBhc3luYyBzZXRSZWdpc3Rlck9uSm9pbkFjY2Vzc0tleSAodG8gOiBzdHJpbmcpIDogUHJvbWlzZTx2b2lkPiB7XG4gICAgYXdhaXQgdGhpcy5zZXQoe1xuICAgICAgcmVnaXN0ZXJPbkpvaW5BY2Nlc3NLZXk6IHRvLFxuICAgIH0pXG4gIH1cblxuICAvKipcbiAgICogVW5yZWdpc3RlciB0aGUgYXBwbGljYXRpb24gZnJvbSB0aGUgaGFuZGxlci5cbiAgICovXG4gIGFzeW5jIHVucmVnaXN0ZXIgKCkgOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCByZXEgPSBuZXcgcHJvdG8uQXBwbGljYXRpb25JZGVudGlmaWVyKClcbiAgICByZXEuc2V0QXBwSWQodGhpcy5hcHBJRClcbiAgICByZXR1cm4gdGhpcy5leGVjKHRoaXMuY2xpZW50LmRlbGV0ZUFwcGxpY2F0aW9uLCByZXEpXG4gIH1cblxuICAvKiogQHByaXZhdGUgKi9cbiAgYXN5bmMgc2V0ICh1cGRhdGVzIDogQXBwbGljYXRpb25VcGRhdGVzID0ge30pIDogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgcmVxID0gbmV3IHByb3RvLkFwcGxpY2F0aW9uKClcblxuICAgIHJlcS5zZXRBcHBJZCh0aGlzLmFwcElEKVxuXG4gICAgaWYgKFwicGF5bG9hZEZvcm1hdFwiIGluIHVwZGF0ZXMpIHtcbiAgICAgIHJlcS5zZXRQYXlsb2FkRm9ybWF0KHVwZGF0ZXMucGF5bG9hZEZvcm1hdClcbiAgICB9XG5cbiAgICBpZiAoXCJyZWdpc3Rlck9uSm9pbkFjY2Vzc0tleVwiIGluIHVwZGF0ZXMpIHtcbiAgICAgIHJlcS5zZXRSZWdpc3Rlck9uSm9pbkFjY2Vzc0tleSh1cGRhdGVzLnJlZ2lzdGVyT25Kb2luQWNjZXNzS2V5KVxuICAgIH1cblxuICAgIGlmIChcImRlY29kZXJcIiBpbiB1cGRhdGVzKSB7XG4gICAgICByZXEuc2V0RGVjb2Rlcih1cGRhdGVzLmRlY29kZXIpXG4gICAgfVxuXG4gICAgaWYgKFwiY29udmVydGVyXCIgaW4gdXBkYXRlcykge1xuICAgICAgcmVxLnNldENvbnZlcnRlcih1cGRhdGVzLmNvbnZlcnRlcilcbiAgICB9XG5cbiAgICBpZiAoXCJ2YWxpZGF0b3JcIiBpbiB1cGRhdGVzKSB7XG4gICAgICByZXEuc2V0VmFsaWRhdG9yKHVwZGF0ZXMudmFsaWRhdG9yKVxuICAgIH1cblxuICAgIGlmIChcImVuY29kZXJcIiBpbiB1cGRhdGVzKSB7XG4gICAgICByZXEuc2V0RW5jb2Rlcih1cGRhdGVzLmVuY29kZXIpXG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuZXhlYyh0aGlzLmNsaWVudC5zZXRBcHBsaWNhdGlvbiwgcmVxKVxuICB9XG5cbiAgLyoqXG4gICAqIExpc3QgdGhlIGRldmljZXMgb2YgdGhlIGFwcGxpY2F0aW9uXG4gICAqL1xuICBhc3luYyBkZXZpY2VzICgpIDogUHJvbWlzZTxEZXZpY2VbXT4ge1xuICAgIGNvbnN0IHJlcSA9IG5ldyBwcm90by5BcHBsaWNhdGlvbklkZW50aWZpZXIoKVxuICAgIHJlcS5zZXRBcHBJZCh0aGlzLmFwcElEKVxuICAgIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMuZXhlYyh0aGlzLmNsaWVudC5nZXREZXZpY2VzRm9yQXBwbGljYXRpb24sIHJlcSlcbiAgICByZXR1cm4gcmVzLmRldmljZXNMaXN0Lm1hcChub3JtYWxpemUpXG4gIH1cblxuICAvKipcbiAgICogUmVnaXN0ZXIgYSBkZXZpY2UgaW4gdGhlIGFwcGxpY2F0aW9uLlxuICAgKi9cbiAgYXN5bmMgcmVnaXN0ZXJEZXZpY2UgKGRldklEIDogc3RyaW5nLCBkZXZpY2UgOiBEZXZpY2VVcGRhdGVzKSA6IFByb21pc2U8dm9pZD4ge1xuICAgIHJldHVybiB0aGlzLnNldERldmljZShkZXZJRCwgZGV2aWNlKVxuICB9XG5cbiAgLyoqXG4gICAqIEdldCB0aGUgZGV2aWNlIHNwZWNpZmllZCBieSB0aGUgZGV2SURcbiAgICovXG4gIGFzeW5jIGRldmljZSAoZGV2SUQgOiBzdHJpbmcpIDogUHJvbWlzZTxEZXZpY2U+IHtcbiAgICBjb25zdCByZXEgPSBuZXcgcHJvdG8uRGV2aWNlSWRlbnRpZmllcigpXG4gICAgcmVxLnNldEFwcElkKHRoaXMuYXBwSUQpXG4gICAgcmVxLnNldERldklkKGRldklEKVxuICAgIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMuZXhlYyh0aGlzLmNsaWVudC5nZXREZXZpY2UsIHJlcSlcbiAgICByZXR1cm4gbm9ybWFsaXplKHJlcylcbiAgfVxuXG4gIC8qKiBAcHJpdmF0ZSAqL1xuICBhc3luYyBzZXREZXZpY2UgKGRldklEIDogc3RyaW5nLCBkZXZpY2UgOiBEZXZpY2VVcGRhdGVzKSA6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IHJlcSA9IHRoaXMuZGV2aWNlUmVxdWVzdChkZXZJRCwgZGV2aWNlKVxuICAgIHJldHVybiB0aGlzLmV4ZWModGhpcy5jbGllbnQuc2V0RGV2aWNlLCByZXEpXG4gIH1cblxuICAvKipcbiAgICogVXBkYXRlIHRoZSBkZXZpY2Ugc3BlY2lmaWVkIGJ5IHRoZSBkZXZJRCB3aXRoIHRoZSBzcGVjaWZpZWQgdXBkYXRlc1xuICAgKi9cbiAgYXN5bmMgdXBkYXRlRGV2aWNlIChkZXZJRCA6IHN0cmluZywgdXBkYXRlcyA6IERldmljZVVwZGF0ZXMpIDogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgZGV2aWNlID0gYXdhaXQgdGhpcy5kZXZpY2UoZGV2SUQpXG4gICAgY29uc3QgcmVxID0gdGhpcy5kZXZpY2VSZXF1ZXN0KGRldklELCB7IC4uLmRldmljZSwgLi4udXBkYXRlcyB9KVxuICAgIHJldHVybiB0aGlzLmV4ZWModGhpcy5jbGllbnQuc2V0RGV2aWNlLCByZXEpXG4gIH1cblxuICAvKipcbiAgICogRGVsZXRlIHRoZSBzcGVjaWZpZWQgZGV2aWNlLlxuICAgKi9cbiAgYXN5bmMgZGVsZXRlRGV2aWNlIChkZXZJRCA6IHN0cmluZykgOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCByZXEgPSBuZXcgcHJvdG8uRGV2aWNlSWRlbnRpZmllcigpXG4gICAgcmVxLnNldEFwcElkKHRoaXMuYXBwSUQpXG4gICAgcmVxLnNldERldklkKGRldklEKVxuICAgIHJldHVybiB0aGlzLmV4ZWModGhpcy5jbGllbnQuZGVsZXRlRGV2aWNlLCByZXEpXG4gIH1cblxuICAvKiogQHByaXZhdGUgKi9cbiAgZGV2aWNlUmVxdWVzdCAoZGV2SUQgOiBzdHJpbmcsIGRldmljZSA6IERldmljZVVwZGF0ZXMgPSB7fSkgOiBhbnkge1xuICAgIGNvbnN0IHJlcSA9IG5ldyBwcm90by5EZXZpY2UoKVxuICAgIHJlcS5zZXRBcHBJZCh0aGlzLmFwcElEKVxuICAgIHJlcS5zZXREZXZJZChkZXZJRClcblxuICAgIGlmIChcImRlc2NyaXB0aW9uXCIgaW4gZGV2aWNlKSB7XG4gICAgICByZXEuc2V0RGVzY3JpcHRpb24oZGV2aWNlLmRlc2NyaXB0aW9uKVxuICAgIH1cblxuICAgIGlmIChcImxhdGl0dWRlXCIgaW4gZGV2aWNlKSB7XG4gICAgICByZXEuc2V0TGF0aXR1ZGUoZGV2aWNlLmxhdGl0dWRlKVxuICAgIH1cblxuICAgIGlmIChcImxvbmdpdHVkZVwiIGluIGRldmljZSkge1xuICAgICAgcmVxLnNldExvbmdpdHVkZShkZXZpY2UubG9uZ2l0dWRlKVxuICAgIH1cblxuICAgIGlmIChcImFsdGl0dWRlXCIgaW4gZGV2aWNlKSB7XG4gICAgICByZXEuc2V0QWx0aXR1ZGUoZGV2aWNlLmFsdGl0dWRlKVxuICAgIH1cblxuICAgIGlmIChcImF0dHJpYnV0ZXNcIiBpbiBkZXZpY2UpIHtcbiAgICAgIE9iamVjdC5rZXlzKGRldmljZS5hdHRyaWJ1dGVzKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHtcbiAgICAgICAgcmVxLmdldEF0dHJpYnV0ZXNNYXAoKS5zZXQoa2V5LCBkZXZpY2UuYXR0cmlidXRlc1trZXldKVxuICAgICAgfSlcbiAgICB9XG5cbiAgICByZXEuc2V0TG9yYXdhbkRldmljZSh0aGlzLmxvcmF3YW5EZXZpY2VSZXF1ZXN0KGRldklELCBkZXZpY2UpKVxuXG4gICAgcmV0dXJuIHJlcVxuICB9XG5cbiAgLyoqIEBwcml2YXRlICovXG4gIGxvcmF3YW5EZXZpY2VSZXF1ZXN0IChkZXZJRCA6IHN0cmluZywgZGV2aWNlIDogTG9yYXdhbkRldmljZVVwZGF0ZXMgPSB7fSkgOiBhbnkge1xuICAgIGNvbnN0IHJlcSA9IG5ldyBsb3Jhd2FuLkRldmljZSgpXG5cbiAgICByZXEuc2V0QXBwSWQodGhpcy5hcHBJRClcbiAgICByZXEuc2V0RGV2SWQoZGV2SUQpXG5cbiAgICBpZiAoXCJhcHBFdWlcIiBpbiBkZXZpY2UpIHtcbiAgICAgIHJlcS5zZXRBcHBFdWkobmV3IFVpbnQ4QXJyYXkobmV3IEJ1ZmZlcihkZXZpY2UuYXBwRXVpLCBcImhleFwiKSkpXG4gICAgfVxuXG4gICAgaWYgKFwiZGV2RXVpXCIgaW4gZGV2aWNlKSB7XG4gICAgICByZXEuc2V0RGV2RXVpKG5ldyBVaW50OEFycmF5KG5ldyBCdWZmZXIoZGV2aWNlLmRldkV1aSwgXCJoZXhcIikpKVxuICAgIH1cblxuICAgIGlmIChcImRldkFkZHJcIiBpbiBkZXZpY2UpIHtcbiAgICAgIHJlcS5zZXREZXZBZGRyKG5ldyBVaW50OEFycmF5KG5ldyBCdWZmZXIoZGV2aWNlLmRldkFkZHIsIFwiaGV4XCIpKSlcbiAgICB9XG5cbiAgICBpZiAoXCJud2tTS2V5XCIgaW4gZGV2aWNlKSB7XG4gICAgICByZXEuc2V0TndrU0tleShuZXcgVWludDhBcnJheShuZXcgQnVmZmVyKGRldmljZS5ud2tTS2V5LCBcImhleFwiKSkpXG4gICAgfVxuXG4gICAgaWYgKFwiYXBwU0tleVwiIGluIGRldmljZSkge1xuICAgICAgcmVxLnNldEFwcFNLZXkobmV3IFVpbnQ4QXJyYXkobmV3IEJ1ZmZlcihkZXZpY2UuYXBwU0tleSwgXCJoZXhcIikpKVxuICAgIH1cblxuICAgIGlmIChcImFwcEtleVwiIGluIGRldmljZSkge1xuICAgICAgcmVxLnNldEFwcEtleShuZXcgVWludDhBcnJheShuZXcgQnVmZmVyKGRldmljZS5hcHBLZXksIFwiaGV4XCIpKSlcbiAgICB9XG5cbiAgICBpZiAoXCJmQ250VXBcIiBpbiBkZXZpY2UpIHtcbiAgICAgIHJlcS5zZXRGQ250VXAoZGV2aWNlLmZDbnRVcClcbiAgICB9XG5cbiAgICBpZiAoXCJmQ250RG93blwiIGluIGRldmljZSkge1xuICAgICAgcmVxLnNldEZDbnREb3duKGRldmljZS5mQ250RG93bilcbiAgICB9XG5cbiAgICBpZiAoXCJkaXNhYmxlRkNudENoZWNrXCIgaW4gZGV2aWNlKSB7XG4gICAgICByZXEuc2V0RGlzYWJsZUZDbnRDaGVjayhkZXZpY2UuZGlzYWJsZUZDbnRDaGVjaylcbiAgICB9XG5cbiAgICBpZiAoXCJ1c2VzMzJCaXRGQ250XCIgaW4gZGV2aWNlKSB7XG4gICAgICByZXEuc2V0VXNlczMyQml0RkNudChkZXZpY2UudXNlczMyQml0RkNudClcbiAgICB9XG5cbiAgICByZXR1cm4gcmVxXG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgRVVJKHMpIGZvciB0aGlzIGFwcGxpY2F0aW9uIGZyb20gdGhlIGFjY291bnQgc2VydmVyLlxuICAgKi9cbiAgYXN5bmMgZ2V0RVVJcyAoKSA6IFByb21pc2U8QXJyYXk8c3RyaW5nPj4ge1xuICAgIGNvbnN0IGFwcEluZm8gPSBhd2FpdCB0aGlzLmFjY291bnRDbGllbnQuZ2V0QXBwbGljYXRpb24odGhpcy5hcHBJRClcblxuICAgIHJldHVybiBhcHBJbmZvLmV1aXNcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm4gYSBkZXZpY2UgYWRkcmVzcyBmb3IgdGhlIGdpdmVuIGNvbnN0cmFpbnRzLlxuICAgKlxuICAgKiBAcGFyYW0gdXNhZ2UgLSBUaGUgbGlzdCBmb3Igd2ljaCB0aGUgYWRkcmVzcyB3aWxsIGJlIHVzZWQuXG4gICAqIEByZXR1cm5zIGFkZHJlc3MgLSBBIGJ1ZmZlciBjb250YWluaW5nIHRoZSBhZGRyZXNzLlxuICAgKi9cbiAgYXN5bmMgZ2V0RGV2aWNlQWRkcmVzcyAodXNhZ2UgOiBBcnJheTxVc2FnZT4gPSBbIFwiYWJwXCIgXSkgOiBQcm9taXNlPEJ1ZmZlcj4ge1xuICAgIGNvbnN0IGNsaWVudCA9IG5ldyBhZGRyLkRldkFkZHJNYW5hZ2VyQ2xpZW50KHRoaXMubmV0QWRkcmVzcywgdGhpcy5jcmVkZW50aWFscylcbiAgICBjb25zdCByZXEgPSBuZXcgZGV2YWRkci5EZXZBZGRyUmVxdWVzdCgpXG4gICAgcmVxLnNldFVzYWdlTGlzdCh1c2FnZSlcblxuICAgIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMuZXhlYyhjbGllbnQuZ2V0RGV2QWRkciwgcmVxKVxuXG4gICAgcmV0dXJuIG5ldyBCdWZmZXIocmVzLmRldkFkZHIsIFwiYmFzZTY0XCIpXG4gIH1cbn1cblxuIl19