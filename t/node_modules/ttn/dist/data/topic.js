"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.validWildcards = exports.wildcards = exports.devID = exports.downlinkTopic = exports.eventTopic = exports.uplinkTopic = exports.topic = exports.wildcard = undefined;

var _toConsumableArray2 = require("babel-runtime/helpers/toConsumableArray");

var _toConsumableArray3 = _interopRequireDefault(_toConsumableArray2);

var _sourceMapSupport2 = require("source-map-support");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

(0, _sourceMapSupport2.install)();
// Copyright Â© 2017 The Things Network
// Use of this source code is governed by the MIT license that can be found in the LICENSE file.

var wildcard = exports.wildcard = "+";

var regex = /^[a-z0-9](?:[_-]?[a-z0-9]){1,35}$/;
var validID = function validID() {
  var str = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : "";
  var type = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : "";

  if (!regex.test(str)) {
    throw new Error("Invalid " + (type ? type.concat(" ") : "") + "id '" + str + "'");
  }
};

var validIDOrWildcard = function validIDOrWildcard() {
  var str = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : "";
  var type = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : "";

  if (str === wildcard) {
    return;
  }

  return validID(str, type);
};

var collapse = function collapse(t) {
  return t.replace(/#.*/g, "#");
};

/**
 * @private
 * Build a topic.
 */
var topic = exports.topic = function topic() {
  for (var _len = arguments.length, parts = Array(_len), _key = 0; _key < _len; _key++) {
    parts[_key] = arguments[_key];
  }

  return collapse(parts.filter(function (part) {
    return Boolean(part);
  }).join("/"));
};

/**
 * @private
 * Build the topic for uplink
 */
var uplinkTopic = exports.uplinkTopic = function uplinkTopic() {
  for (var _len2 = arguments.length, args = Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {
    args[_key2] = arguments[_key2];
  }

  switch (args.length) {
    case 0:
      return uplinkTopic(wildcard);
    case 1:
      var devID_ = args[0];

      return uplinkTopic(devID_, undefined);
    case 2:
      var devID__ = args[0],
          fieldName_ = args[1];

      return uplinkTopic(wildcard, devID__, fieldName_);
    case 3:
      var appID = args[0],
          _devID = args[1],
          fieldName = args[2];

      validIDOrWildcard(appID, "application");
      validIDOrWildcard(_devID, "device");
      return topic(appID, "devices", _devID, "up", fieldName);
  }

  throw new Error("Could not build uplink topic from " + args.join(","));
};

/**
 * @private
 * Build the topic for events
 */
var eventTopic = exports.eventTopic = function eventTopic() {
  for (var _len3 = arguments.length, args = Array(_len3), _key3 = 0; _key3 < _len3; _key3++) {
    args[_key3] = arguments[_key3];
  }

  switch (args.length) {
    case 0:
      return eventTopic(wildcard);
    case 1:
      var devID_ = args[0];

      return eventTopic(devID_, "#");
    case 2:
      var devID__ = args[0],
          name_ = args[1];

      return eventTopic(wildcard, devID__, name_);
    case 3:
      var appID = args[0],
          _devID2 = args[1],
          name = args[2];

      validIDOrWildcard(appID, "application");
      validIDOrWildcard(_devID2, "device");
      return topic(appID, "devices", _devID2, "events", name);
  }

  throw new Error("Could not build event topic from " + args.join(","));
};

/**
 * @private
 * Build the topic for downlink
 */
var downlinkTopic = exports.downlinkTopic = function downlinkTopic(appID, devID) {
  validID(appID, "application");
  validID(devID, "device");

  return topic(appID, "devices", devID, "down");
};

var valid = function valid(topic) {
  var parts = topic.split("/");
  return parts.length >= 4 && parts[0] !== "#" && parts[1] === "devices" && parts[2] !== "#" && (parts[3] === "up" || parts[3] === "events");
};

var unique = function unique(value, index, self) {
  return self.indexOf(value) === index;
};

var combos = function combos(a, b) {
  if (a.length === 0) {
    return b.map(function (el) {
      return [el];
    });
  }

  if (b.length === 0) {
    return a.map(function (el) {
      return [el];
    });
  }

  return a.reduce(function (acc, ael) {
    return [].concat((0, _toConsumableArray3.default)(acc), (0, _toConsumableArray3.default)(b.map(function (bel) {
      return [ael, bel];
    })));
  }, []);
};

var allcombos = function allcombos(first) {
  for (var _len4 = arguments.length, args = Array(_len4 > 1 ? _len4 - 1 : 0), _key4 = 1; _key4 < _len4; _key4++) {
    args[_key4 - 1] = arguments[_key4];
  }

  if (args.length === 0) {
    return first;
  }

  var fst = args[0],
      rest = args.slice(1);

  var cc = combos(first, fst).map(function (el) {
    return topic.apply(undefined, (0, _toConsumableArray3.default)(el));
  }).filter(unique);

  return allcombos.apply(undefined, [cc].concat((0, _toConsumableArray3.default)(rest)));
};

var devID = exports.devID = function devID(t) {
  return t.split("/")[2] || "+";
};

/**
 * @private
 * Generate all wildcard possibilities for a given topic.
 * eg. a/b/c becomes
 *  - a/b/c
 *  - a/b/#
 *  - a/b/+
 *  - a/#
 *  - a/+/#
 *  - a/+/+
 *  - +/b/c
 *  - +/b/#
 *  - +/b/+
 *  - +/#
 *  - +/+/c
 *  - +/+/#
 *  - +/+/+
 */
var wildcards = exports.wildcards = function wildcards(t) {
  var parts = t.split("/");

  var l = parts.map(function (part) {
    return [part, "#", "+"];
  });

  return allcombos.apply(undefined, (0, _toConsumableArray3.default)(l)).filter(unique);
};

/**
 * @private
 * Same as `wildcards` but filters the ouput on valid topics for The Things
 * Network.
 */
var validWildcards = exports.validWildcards = function validWildcards(t) {
  return wildcards(t).filter(valid);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9kYXRhL3RvcGljLmpzIl0sIm5hbWVzIjpbIndpbGRjYXJkIiwicmVnZXgiLCJ2YWxpZElEIiwic3RyIiwidHlwZSIsInRlc3QiLCJFcnJvciIsImNvbmNhdCIsInZhbGlkSURPcldpbGRjYXJkIiwiY29sbGFwc2UiLCJ0IiwicmVwbGFjZSIsInRvcGljIiwicGFydHMiLCJmaWx0ZXIiLCJCb29sZWFuIiwicGFydCIsImpvaW4iLCJ1cGxpbmtUb3BpYyIsImFyZ3MiLCJsZW5ndGgiLCJkZXZJRF8iLCJ1bmRlZmluZWQiLCJkZXZJRF9fIiwiZmllbGROYW1lXyIsImFwcElEIiwiZGV2SUQiLCJmaWVsZE5hbWUiLCJldmVudFRvcGljIiwibmFtZV8iLCJuYW1lIiwiZG93bmxpbmtUb3BpYyIsInZhbGlkIiwic3BsaXQiLCJ1bmlxdWUiLCJ2YWx1ZSIsImluZGV4Iiwic2VsZiIsImluZGV4T2YiLCJjb21ib3MiLCJhIiwiYiIsIm1hcCIsImVsIiwicmVkdWNlIiwiYWNjIiwiYWVsIiwiYmVsIiwiYWxsY29tYm9zIiwiZmlyc3QiLCJmc3QiLCJyZXN0IiwiY2MiLCJ3aWxkY2FyZHMiLCJsIiwidmFsaWRXaWxkY2FyZHMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTtBQUNBOztBQU9PLElBQU1BLDhCQUFvQixHQUExQjs7QUFFUCxJQUFNQyxRQUFRLG1DQUFkO0FBQ0EsSUFBTUMsVUFBVSxTQUFWQSxPQUFVLEdBQXdEO0FBQUEsTUFBOUNDLEdBQThDLHVFQUEvQixFQUErQjtBQUFBLE1BQTNCQyxJQUEyQix1RUFBWCxFQUFXOztBQUN0RSxNQUFJLENBQUNILE1BQU1JLElBQU4sQ0FBV0YsR0FBWCxDQUFMLEVBQXNCO0FBQ3BCLFVBQU0sSUFBSUcsS0FBSixlQUFxQkYsT0FBT0EsS0FBS0csTUFBTCxDQUFZLEdBQVosQ0FBUCxHQUEwQixFQUEvQyxhQUF3REosR0FBeEQsT0FBTjtBQUNEO0FBQ0YsQ0FKRDs7QUFNQSxJQUFNSyxv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QUFJekMsTUFBTTZCLEdBQU4sQ0FBVSxVQUFVMUIsSUFBVixFQUF5QztBQUMzRCxXQUFPLENBQ0xBLElBREssRUFFTCxHQUZLLEVBR0wsR0FISyxDQUFQO0FBS0QsR0FOUyxDQUFWOztBQVFBLFNBQU9nQyw0REFBYU0sQ0FBYixHQUFnQnhDLE1BQWhCLENBQXVCb0IsTUFBdkIsQ0FBUDtBQUNELENBWk07O0FBY1A7Ozs7O0FBS08sSUFBTXFCLDBDQUFpQixTQUFqQkEsY0FBaUIsQ0FBVTdDLENBQVYsRUFBc0M7QUFDbEUsU0FBTzJDLFVBQVUzQyxDQUFWLEVBQWFJLE1BQWIsQ0FBb0JrQixLQUFwQixDQUFQO0FBQ0QsQ0FGTSIsImZpbGUiOiJ0b3BpYy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCDCqSAyMDE3IFRoZSBUaGluZ3MgTmV0d29ya1xuLy8gVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgdGhlIE1JVCBsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuXG5cbi8vIEBmbG93XG5cbi8qKlxuICogVGhlIHdpbGRjYXJkIHRvcGljLiBVc2UgdGhpcyB0byBleHBsaWNpdGx5IGJ1aWxkIHF1ZXJpZXMgZm9yIGFsbCBkZXZpY2VzLlxuICovXG5leHBvcnQgY29uc3Qgd2lsZGNhcmQgOiBzdHJpbmcgPSBcIitcIlxuXG5jb25zdCByZWdleCA9IC9eW2EtejAtOV0oPzpbXy1dP1thLXowLTldKXsxLDM1fSQvXG5jb25zdCB2YWxpZElEID0gZnVuY3Rpb24gKHN0ciA6IHN0cmluZyA9IFwiXCIsIHR5cGUgOiBzdHJpbmcgPSBcIlwiKSA6IHZvaWQge1xuICBpZiAoIXJlZ2V4LnRlc3Qoc3RyKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCAke3R5cGUgPyB0eXBlLmNvbmNhdChcIiBcIikgOiBcIlwifWlkICcke3N0cn0nYClcbiAgfVxufVxuXG5jb25zdCB2YWxpZElET3JXaWxkY2FyZCA9IGZ1bmN0aW9uIChzdHIgOiBzdHJpbmcgPSBcIlwiLCB0eXBlIDogc3RyaW5nID0gXCJcIikgOiB2b2lkIHtcbiAgaWYgKHN0ciA9PT0gd2lsZGNhcmQpIHtcbiAgICByZXR1cm5cbiAgfVxuXG4gIHJldHVybiB2YWxpZElEKHN0ciwgdHlwZSlcbn1cblxuY29uc3QgY29sbGFwc2UgPSBmdW5jdGlvbiAodCA6IHN0cmluZykgOiBzdHJpbmcge1xuICByZXR1cm4gdC5yZXBsYWNlKC8jLiovZywgXCIjXCIpXG59XG5cblxuLyoqXG4gKiBAcHJpdmF0ZVxuICogQnVpbGQgYSB0b3BpYy5cbiAqL1xuZXhwb3J0IGNvbnN0IHRvcGljID0gZnVuY3Rpb24gKC4uLnBhcnRzIDogQXJyYXk8c3RyaW5nIHwgdm9pZD4pIDogc3RyaW5nIHtcbiAgcmV0dXJuIGNvbGxhcHNlKHBhcnRzLmZpbHRlcihwYXJ0ID0+IEJvb2xlYW4ocGFydCkpLmpvaW4oXCIvXCIpKVxufVxuXG4vKipcbiAqIEBwcml2YXRlXG4gKiBCdWlsZCB0aGUgdG9waWMgZm9yIHVwbGlua1xuICovXG5leHBvcnQgY29uc3QgdXBsaW5rVG9waWMgPSBmdW5jdGlvbiAoLi4uYXJncyA6IEFycmF5PHN0cmluZyB8IHZvaWQ+KSA6IHN0cmluZyB7XG4gIHN3aXRjaCAoYXJncy5sZW5ndGgpIHtcbiAgY2FzZSAwOlxuICAgIHJldHVybiB1cGxpbmtUb3BpYyh3aWxkY2FyZClcbiAgY2FzZSAxOlxuICAgIGNvbnN0IFsgZGV2SURfIF0gPSBhcmdzXG4gICAgcmV0dXJuIHVwbGlua1RvcGljKGRldklEXywgdW5kZWZpbmVkKVxuICBjYXNlIDI6XG4gICAgY29uc3QgWyBkZXZJRF9fLCBmaWVsZE5hbWVfIF0gPSBhcmdzXG4gICAgcmV0dXJuIHVwbGlua1RvcGljKHdpbGRjYXJkLCBkZXZJRF9fLCBmaWVsZE5hbWVfKVxuICBjYXNlIDM6XG4gICAgY29uc3QgWyBhcHBJRCwgZGV2SUQsIGZpZWxkTmFtZSBdID0gYXJnc1xuICAgIHZhbGlkSURPcldpbGRjYXJkKGFwcElELCBcImFwcGxpY2F0aW9uXCIpXG4gICAgdmFsaWRJRE9yV2lsZGNhcmQoZGV2SUQsIFwiZGV2aWNlXCIpXG4gICAgcmV0dXJuIHRvcGljKGFwcElELCBcImRldmljZXNcIiwgZGV2SUQsIFwidXBcIiwgZmllbGROYW1lKVxuICB9XG5cbiAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3QgYnVpbGQgdXBsaW5rIHRvcGljIGZyb20gJHthcmdzLmpvaW4oXCIsXCIpfWApXG59XG5cbi8qKlxuICogQHByaXZhdGVcbiAqIEJ1aWxkIHRoZSB0b3BpYyBmb3IgZXZlbnRzXG4gKi9cbmV4cG9ydCBjb25zdCBldmVudFRvcGljID0gZnVuY3Rpb24gKC4uLmFyZ3MgOiBBcnJheTxzdHJpbmcgfCB2b2lkPikgOiBzdHJpbmcge1xuICBzd2l0Y2ggKGFyZ3MubGVuZ3RoKSB7XG4gIGNhc2UgMDpcbiAgICByZXR1cm4gZXZlbnRUb3BpYyh3aWxkY2FyZClcbiAgY2FzZSAxOlxuICAgIGNvbnN0IFsgZGV2SURfIF0gPSBhcmdzXG4gICAgcmV0dXJuIGV2ZW50VG9waWMoZGV2SURfLCBcIiNcIilcbiAgY2FzZSAyOlxuICAgIGNvbnN0IFsgZGV2SURfXywgbmFtZV8gXSA9IGFyZ3NcbiAgICByZXR1cm4gZXZlbnRUb3BpYyh3aWxkY2FyZCwgZGV2SURfXywgbmFtZV8pXG4gIGNhc2UgMzpcbiAgICBjb25zdCBbIGFwcElELCBkZXZJRCwgbmFtZSBdID0gYXJnc1xuICAgIHZhbGlkSURPcldpbGRjYXJkKGFwcElELCBcImFwcGxpY2F0aW9uXCIpXG4gICAgdmFsaWRJRE9yV2lsZGNhcmQoZGV2SUQsIFwiZGV2aWNlXCIpXG4gICAgcmV0dXJuIHRvcGljKGFwcElELCBcImRldmljZXNcIiwgZGV2SUQsIFwiZXZlbnRzXCIsIG5hbWUpXG4gIH1cblxuICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCBidWlsZCBldmVudCB0b3BpYyBmcm9tICR7YXJncy5qb2luKFwiLFwiKX1gKVxufVxuXG4vKipcbiAqIEBwcml2YXRlXG4gKiBCdWlsZCB0aGUgdG9waWMgZm9yIGRvd25saW5rXG4gKi9cbmV4cG9ydCBjb25zdCBkb3dubGlua1RvcGljID0gZnVuY3Rpb24gKGFwcElEIDogc3RyaW5nLCBkZXZJRCA6IHN0cmluZykgOiBzdHJpbmcge1xuICB2YWxpZElEKGFwcElELCBcImFwcGxpY2F0aW9uXCIpXG4gIHZhbGlkSUQoZGV2SUQsIFwiZGV2aWNlXCIpXG5cbiAgcmV0dXJuIHRvcGljKGFwcElELCBcImRldmljZXNcIiwgZGV2SUQsIFwiZG93blwiKVxufVxuXG5cbmNvbnN0IHZhbGlkID0gZnVuY3Rpb24gKHRvcGljKSB7XG4gIGNvbnN0IHBhcnRzID0gdG9waWMuc3BsaXQoXCIvXCIpXG4gIHJldHVybiBwYXJ0cy5sZW5ndGggPj0gNCAmJiBwYXJ0c1swXSAhPT0gXCIjXCIgJiYgcGFydHNbMV0gPT09IFwiZGV2aWNlc1wiICYmIHBhcnRzWzJdICE9PSBcIiNcIiAmJiAocGFydHNbM10gPT09IFwidXBcIiB8fCBwYXJ0c1szXSA9PT0gXCJldmVudHNcIilcbn1cblxuY29uc3QgdW5pcXVlID0gZnVuY3Rpb24gKHZhbHVlLCBpbmRleCwgc2VsZikge1xuICByZXR1cm4gc2VsZi5pbmRleE9mKHZhbHVlKSA9PT0gaW5kZXhcbn1cblxuY29uc3QgY29tYm9zID0gZnVuY3Rpb24gKGEgOiBBcnJheTxzdHJpbmc+LCBiIDogQXJyYXk8c3RyaW5nPikgOiBBcnJheTxBcnJheTxzdHJpbmc+PiB7XG4gIGlmIChhLmxlbmd0aCA9PT0gMCkge1xuICAgIHJldHVybiBiLm1hcChlbCA9PiBbIGVsIF0pXG4gIH1cblxuICBpZiAoYi5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4gYS5tYXAoZWwgPT4gWyBlbCBdKVxuICB9XG5cbiAgcmV0dXJuIGEucmVkdWNlKGZ1bmN0aW9uIChhY2MsIGFlbCkge1xuICAgIHJldHVybiBbXG4gICAgICAuLi5hY2MsXG4gICAgICAuLi5iLm1hcChiZWwgPT4gWyBhZWwsIGJlbCBdKSxcbiAgICBdXG4gIH0sIFtdKVxufVxuXG5jb25zdCBhbGxjb21ib3MgPSBmdW5jdGlvbiAoZmlyc3QgOiBBcnJheTxzdHJpbmc+LCAuLi5hcmdzIDogQXJyYXk8QXJyYXk8c3RyaW5nPj4pIDogQXJyYXk8c3RyaW5nPiB7XG4gIGlmIChhcmdzLmxlbmd0aCA9PT0gMCkge1xuICAgIHJldHVybiBmaXJzdFxuICB9XG5cbiAgY29uc3QgWyBmc3QsIC4uLnJlc3QgXSA9IGFyZ3NcbiAgY29uc3QgY2MgPSBjb21ib3MoZmlyc3QsIGZzdCkubWFwKGVsID0+IHRvcGljKC4uLmVsKSkuZmlsdGVyKHVuaXF1ZSlcblxuICByZXR1cm4gYWxsY29tYm9zKGNjLCAuLi5yZXN0KVxufVxuXG5cbmV4cG9ydCBjb25zdCBkZXZJRCA9IGZ1bmN0aW9uICh0IDogc3RyaW5nKSA6IHN0cmluZyB7XG4gIHJldHVybiB0LnNwbGl0KFwiL1wiKVsyXSB8fCBcIitcIlxufVxuXG4vKipcbiAqIEBwcml2YXRlXG4gKiBHZW5lcmF0ZSBhbGwgd2lsZGNhcmQgcG9zc2liaWxpdGllcyBmb3IgYSBnaXZlbiB0b3BpYy5cbiAqIGVnLiBhL2IvYyBiZWNvbWVzXG4gKiAgLSBhL2IvY1xuICogIC0gYS9iLyNcbiAqICAtIGEvYi8rXG4gKiAgLSBhLyNcbiAqICAtIGEvKy8jXG4gKiAgLSBhLysvK1xuICogIC0gKy9iL2NcbiAqICAtICsvYi8jXG4gKiAgLSArL2IvK1xuICogIC0gKy8jXG4gKiAgLSArLysvY1xuICogIC0gKy8rLyNcbiAqICAtICsvKy8rXG4gKi9cbmV4cG9ydCBjb25zdCB3aWxkY2FyZHMgPSBmdW5jdGlvbiAodCA6IHN0cmluZykgOiBBcnJheTxzdHJpbmc+IHtcbiAgY29uc3QgcGFydHMgOiBBcnJheTxzdHJpbmc+ID0gdC5zcGxpdChcIi9cIilcblxuICBjb25zdCBsID0gcGFydHMubWFwKGZ1bmN0aW9uIChwYXJ0IDogc3RyaW5nKSA6IEFycmF5PHN0cmluZz4ge1xuICAgIHJldHVybiBbXG4gICAgICBwYXJ0LFxuICAgICAgXCIjXCIsXG4gICAgICBcIitcIixcbiAgICBdXG4gIH0pXG5cbiAgcmV0dXJuIGFsbGNvbWJvcyguLi5sKS5maWx0ZXIodW5pcXVlKVxufVxuXG4vKipcbiAqIEBwcml2YXRlXG4gKiBTYW1lIGFzIGB3aWxkY2FyZHNgIGJ1dCBmaWx0ZXJzIHRoZSBvdXB1dCBvbiB2YWxpZCB0b3BpY3MgZm9yIFRoZSBUaGluZ3NcbiAqIE5ldHdvcmsuXG4gKi9cbmV4cG9ydCBjb25zdCB2YWxpZFdpbGRjYXJkcyA9IGZ1bmN0aW9uICh0IDogc3RyaW5nKSA6IEFycmF5PHN0cmluZz4ge1xuICByZXR1cm4gd2lsZGNhcmRzKHQpLmZpbHRlcih2YWxpZClcbn1cblxuXG4iXX0=